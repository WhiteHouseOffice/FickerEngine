name: Agent Debug (Verbose, Non-Failing)
on:
  workflow_dispatch: {}

jobs:
  diag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Print context
        continue-on-error: true
        run: |
          set -x
          echo "EVENT=$GITHUB_EVENT_NAME"
          echo "REF=$GITHUB_REF_NAME"
          echo "SHA=$GITHUB_SHA"
          echo "DEFAULT_BRANCH=$(git remote show origin | sed -n 's/  HEAD branch: //p')"

      - name: List files
        continue-on-error: true
        run: |
          set -x
          git ls-files | sed -n '1,200p'

      - name: Check key files exist
        id: files
        continue-on-error: true
        run: |
          set -x
          for f in scripts/agent/repo_agent.py .github/workflows/agent.yml; do
            if [ -f "$f" ]; then echo "OK $f"; else echo "MISSING $f"; fi
          done

      - name: Check OPENAI secret presence (won't print it)
        id: secret
        continue-on-error: true
        env:
          HAS_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -x
          if [ -n "${HAS_KEY:-}" ]; then
            echo "OPENAI_API_KEY is present ✅"
          else
            echo "OPENAI_API_KEY is NOT set ❌"
          fi

      - name: Python + OpenAI import
        id: py
        continue-on-error: true
        run: |
          set -x
          python3 --version
          pip install -q openai==1.42.0
          python3 - <<'PY'
try:
    import openai
    print("openai imported ✅")
except Exception as e:
    print("openai import failed ❌", e)
PY

      - name: Summarize
        run: |
          echo "---- SUMMARY ----"
          echo "Files check:  see step 'Check key files exist'"
          echo "Secret check: see step 'Check OPENAI secret presence'"
          echo "Python/OpenAI: see step 'Python + OpenAI import'"
          echo "This job is forced to succeed so you can read all logs."
